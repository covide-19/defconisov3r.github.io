<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
  <meta name="description" content="">
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
  <title>Corona Virus Infection Map</title>
  <link rel="stylesheet" href="css/bootstrap.min.css">
  <link rel="stylesheet" href="css/leaflet.css" />
  <link rel="stylesheet" href="css/MarkerCluster.Default.css">
  <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css">
  <link href="https://fonts.googleapis.com/css?family=Titillium+Web|Oswald" rel="stylesheet">
  <link href="css/c3.min.css" rel="stylesheet">
  <link rel="stylesheet" href="css/simplebar.css" />
  <link rel="stylesheet" href="css/main.css">
  <link rel="icon" href="img/favicon.ico" type="image/x-icon">
  <script src="js/d3.js"></script>
  <script src="js/c3.min.js"></script>
  <script src="js/leaflet.js"></script>
  <script src="js/leaflet.markercluster.js"></script>
  <script src="js/leaflet-polygon.fillPattern.js"></script>
  <script src="js/topojson.v1.min.js"></script>
  <script src="js/chroma.min.js"></script>
  <script src="js/jquery-3.3.1.min.js"></script>
  <script src="js/bootstrap.min.js"></script>
  <!-- <script src="https://cdn.jsdelivr.net/gh/gitbrent/bootstrap4-toggle@3.6.1/js/bootstrap4-toggle.min.js"></script> -->
  <script src="js/simplebar.min.js"></script>
</head>

<body>
  <main>
    <div id="mobiledeck">
      <p>
        <span class="mobile-title">Aggr. Confirmed</span>
        <span class="confirmed-count"></span>
        <span class="confirmed-new-count "></span>
        <p>

          <p>
            <span class="mobile-title">Active Confirmed</span>
            <span class="active-count"></span>
            <span class="active-new-count"></span>
            <p>

              <p>
                <span class="mobile-title">Recovered</span>
                <span class="recovered-count"></span>
                <span class="recovered-new-count"></span>
                <p>

                  <p>
                    <span class="mobile-title">Death</span>
                    <span class="death-count"></span>
                    <span class="death-new-count"></span>
                    <p>
    </div>

    <div id="info" data-simplebar data-simplebar-auto-hide="true">
      <div id="title" style="font-size:19px"><img src="img/virus_logo.png" width="28px"> Novel Coronavirus (COVID-19) Infection Map
        <span><a data-toggle="modal" data-target="#resourcewindow"><i class="far fa-newspaper"></i></a></span>
        <span><a data-toggle="modal" data-target="#infowindow"><i class="nav fas fa-question-circle"></i></a></span>
      </div>

      <p><span id="placename">Global Trend</span> </p>
      <div> <span id="date"></span> <span id="hint"> Click a place to review local trend.</span></div>
      <div id="deck-1" class="card-deck counts">
        <div class="card">
          <div class="card-body confirmed">
            <h5 class="card-title">Aggregated Confirmed
              <i class="nav fas fa-exclamation-circle tooltip">
                <span class="tooltiptext">All the confirmed cases ever since the discovery of the COVID-19 in the statistical area.</span>
              </i>
            </h5>
          </div>
          <p class="card-text">
            <span class="confirmed-count"></span><span class="confirmed-new-count">
            </span>
          </p>
        </div>
        <div class="card">
          <div class="card-body active">
            <h5 class="card-title">Active Confirmed
              <i class="nav fas fa-exclamation-circle tooltip">
                <span class="tooltiptext">The remaining confirmed cases. The active confirmed cases excludes the recovered and death cases.</span>
              </i>
            </h5>
          </div>
          <p class="card-text">
            <span class="active-count"></span>
            <span class="active-new-count"></span>
            <i id="counticon" class="nav fas fa-exclamation-circle tooltip counticon active-new-count-tooltip">
              <span class="tooltiptext">The newly increased/decreased confirmed cases: the # of today's active confirmed cases subtract the # of yesterday's.</span>
            </i>

          </p>
        </div>
      </div>
      <div id="deck-2" class="card-deck counts">
        <div class="card">
          <div class="card-body recovered">
            <h5 class="card-title">Recovered</h5>
            <p class="card-text"><span class="recovered-count"></span><span class="recovered-new-count"></span></p>
          </div>
        </div>

        <div class="card">
          <div class="card-body death">
            <h5 class="card-title">Death</h5>
            <p class="card-text"><span class="death-count"></span><span class="death-new-count"></span></p>
          </div>
        </div>
      </div>

      <div id="timeline-chart"></div>
      <div id="total-chart"></div>
      <div id="rank-chart"></div>

      <div id="footer">


        <!--
        <input type="checkbox" id="panelSwitcher" checked data-toggle="toggle" data-on="Map" data-size="xs" data-off="Table" data-onstyle="success" data-offstyle="danger" data-onstyle="outline-secondary" data-offstyle="outline-info"> -->

        <div> In the main map, an country or region's inflection level is measured by the # of today's active/remaining confirmed cases. Its legend is displayed as below. The gray slash texture indicates no previous casese are discovered; the green
          texture means the region in which all the infected cases have recovered.</div>
        <div id="legend-panel" class="card-deck legend">

          <div class="card">
            <div class="card-body">
              <h5 class="card-title grey-circles" style="color:black">no case</h5>
            </div>
          </div>

          <div class="card">
            <div class="card-body legend-color-1">
              <h5 class="card-title" style="color:black">1</h5>

            </div>
          </div>

          <div class="card">
            <div class="card-body legend-color-2">
              <h5 class="card-title" style="color:black">10</h5>

            </div>
          </div>
          <div class="card">
            <div class="card-body  legend-color-3">
              <h5 class="card-title" style="color:black">100</h5>

            </div>
          </div>

          <div class="card">
            <div class="card-body  legend-color-4">
              <h5 class="card-title" style="color:black">250</h5>

            </div>
          </div>

          <div class="card">
            <div class="card-body legend-color-5">
              <h5 class="card-title" style="color:black">1,000</h5>
            </div>
          </div>

          <div class="card">
            <div class="card-body legend-color-6">
              <h5 class="card-title" style="color:black">10,000+</h5>
            </div>
          </div>
        </div>


        <div>Infection Case(s) &nbsp; <i class='fas fa-users community'></i> &nbsp; indicates one or several confirmed infected individual(s) in the U.S., excluding those were identified from the Diamond Princess.
          The dataset of the infected cases are continuously enriched from different data portals such as
          <a href="https://coronavirus.1point3acres.com/en" target="_blank">1point3acres</a> and state officials. Notably, <b style="color:#e8e3d3;text-decoration-line: underline; text-decoration-style: dotted;"> each case was geocoded to an
            approximate location within the county
            which reported the case. The location is by no means identical to the exact address where the case was discovered</b>.
        </div>

        <div>An Infected Community &nbsp; <i class="fas fa-procedures community"> </i> &nbsp; indicates a community or village where confirmed cases were found. The local governments in China have taken strict measures to isolate the residents of
          these
          places from the outside. The dataset of infected community can be found at <a href="https://lab.ahusmart.com/nCoV/api/detail" target="_blank">ahusmart</a>.
        </div>

        <div>The data are mainly collected from <a href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports/" target="_blank">WHO</a>,
          <a href="https://www.cdc.gov/coronavirus/2019-ncov/cases-in-us.html" target="_blank">CDC</a>,
          <a href="https://www.canada.ca/en/public-health/services/diseases/2019-novel-coronavirus-infection.html" target="_blank">PHA</a> ,
          <a href="http://2019ncov.chinacdc.cn/2019-nCoV/" target="_blank">China CDC</a>,
          <a href="https://www.nbcnews.com/health/health-news/coronavirus-u-s-map-where-virus-has-been-confirmed-across-n1124546" target="_blank">NBC News</a>,
          and <a href="https://voice.baidu.com/act/newpneumonia/newpneumonia" target="_blank">Baidu</a>. Regarding the state level data in the U.S., they are collected from CDC, state officials and <a
            href="https://www.nbcnews.com/health/health-news/coronavirus-u-s-map-where-virus-has-been-confirmed-across-n1124546" target="_blank">NBC News</a>.
          The computational resources are provided by <a href="https://csde.washington.edu/" target="_blank">UW's Center for Studies in Demography and Ecology</a>. The base maps are from <a target="_blank"
            href="https://github.com/CartoDB/cartodb/wiki/BaseMaps-available">Carto</a> and <a href="https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/" target="_blank">ESRI</a>, and the geospatial data for the base maps
          are acquired from the <a href="openstreetmap.org/copyright" target="_blank"> OpenStreetMap</a>.
          <span style="color:#e8e3d3">The timely updated dataset of the virus infection can be downloaded <a href="http://hgis.uw.edu/virus/assets/virus.csv" style="color:#e8e3d3; text-decoration: underline;" target="_blank">here</a>.</span> Details
          about this interactive
          map can be found <a data-toggle="modal" data-target="#infowindow"> here</a>.
        </div>
      </div>


    </div>
    <div id="table">
      <div id="table-container">
        <table class="table table-bordered ">
          <thead>
            <tr>
              <th scope="col">Country</th>
              <th scope="col">First</th>
              <th scope="col">Last</th>
              <th scope="col">Handle</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <th scope="row">1</th>
              <td>Mark</td>
              <td>Otto</td>
              <td>@mdo</td>
            </tr>
            <tr>
              <th scope="row">2</th>
              <td>Jacob</td>
              <td>Thornton</td>
              <td>@fat</td>
            </tr>
            <tr>
              <th scope="row">3</th>
              <td colspan="2">Larry the Bird</td>
              <td>@twitter</td>
            </tr>
          </tbody>
        </table>
      </div>



    </div>
    <div id="map"></div>


  </main>
  <div id="infowindow" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="width:1250px!important">
      <div class="modal-content">
        <div class="modal-header">
          <strong class="modal-title" id="exampleModalLongTitle">Info</strong>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="demo" class="carousel " data-ride="carousel">
            <p>This online interactive map enables users to track both the global and local trends of Novel Coronavirus infection since Jan 21st, 2020. The supporting dataset is timely collected from multiple official sources and then plotted onto
              this map.</p>
            <h5>Data Sources</h5>
            <p>The data are mainly collected from 1. <a href="http://www.nhc.gov.cn" target="_blank">National Health Commission</a> (NHC) of the People’s Republic of China
              2. China’s Provincial & Municipal Health Commission, China’s Provincial & Municipal government database
              3. Public data published from Hongkong, Macau, and Taiwan official channels
              4. <a href="https://www.who.int/emergencies/diseases/novel-coronavirus-2019/situation-reports/" target="_blank">World Health Organization</a> (WHO)
              5. <a href="https://www.cdc.gov/coronavirus/2019-ncov/cases-in-us.html" target="_blank">Centers for Disease Control and Prevention</a> (CDC)
              6. <a href="https://www.canada.ca/en/public-health/services/diseases/2019-novel-coronavirus-infection.html" target="_blank">Public Health Agency of Canada</a> (PHAC)
              7. <a href="https://voice.baidu.com/act/newpneumonia/newpneumonia" target="_blank">Baidu</a>.
              8. <a href="https://lab.ahusmart.com/nCoV/api/detail" target="_blank">ahusmart</a> - the infected community in China.
              9. the state officals of different states in the U.S.
              10. <a href="https://www.nbcnews.com/health/health-news/coronavirus-u-s-map-where-virus-has-been-confirmed-across-n1124546" target="_blank">NBC News</a>.
          </div>
        </div>
      </div>
    </div>
  </div>
  <div id="resourcewindow" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" role="document" style="width:1250px!important">
      <div class="modal-content">
        <div class="modal-header">
          <strong class="modal-title" id="exampleModalLongTitle">Resources</strong>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div id="demo" class="carousel " data-ride="carousel">
            <h5>Coronavirus information resources</h5>
			<br><b> Netherlands - Official Websites</b>
            <table style="width:100%">
              <tr>
                <td><a href="https://www.rivm.nl/coronavirus-kaart-van-nederland" target="_blank"> RIVM</a></td>
                <td><a href="https://www.rijksoverheid.nl/onderwerpen/coronavirus-covid-19" target="_blank"> Rijksoverheid</a></td>
              </tr>
            </table>
			<br><b> Germany - Official Websites</b>
            <table style="width:100%">
              <tr>
                <td><a href="https://www.rivm.nl/coronavirus-kaart-van-nederland" target="_blank"> RIVM</a></td>
              </tr>
            </table>
			<br><b> Belgium - Official Websites</b>
            <table style="width:100%">
              <tr>
                <td><a href="https://www.belgium.be/nl/nieuws/2020/coronavirus_fase_2_gehandhaafd_overgang_naar_de_federale_fase_en_bijkomende_maatregelen" target="_blank"> Belgium.be (NL)</a></td>
				<td><a href="https://www.belgium.be/fr/actualites/2020/coronavirus_phase_2_maintenue_passage_en_phase_federale_et_mesures_additionnelles" target="_blank"> Belgium.be (FR)</a></td>
				<td><a href="https://www.belgium.be/de/aktuelles/2020/coronavirus_phase_ii_beibehalten_uebergang_zur_foederalen_phase_und_zusaetzliche" target="_blank"> Belgium.be (DE)</a></td>
              </tr>
            </table>
            <br><b>Other Countries - Official Websites</b>
            <table style="width:100%">
              <tr>
                <td><a href="https://www.cdc.gov/coronavirus/2019-ncov/cases-in-us.html" target="_blank"> the U.S.</a></td>
                <td><a href=" https://www.canada.ca/en/public-health/services/diseases/2019-novel-coronavirus-infection.html" target="_blank"> Canada</a></td>
                <td><a href="https://www.cdc.go.kr/board/board.es?mid=a20501000000&bid=0015" target="_blank"> Republic of Korean</a></td>
              </tr>
              <tr>
                <td><a href="https://www.mhlw.go.jp/stf/newpage_09571.html" target="_blank"> Japan</a></td>
                <td><a href="https://www.health.gov.au/news/health-alerts/novel-coronavirus-2019-ncov-health-alert#current-status" target="_blank"> Australia</a></td>
                <td><a href="https://www.moh.gov.sg/covid-19" target="_blank"> Singapore</a></td>
              </tr>
              <tr>
                <td><a href="http://www.salute.gov.it/nuovocoronavirus" target="_blank"> Italy</a></td>
                <td><a href="https://www.gov.uk/guidance/coronavirus-covid-19-information-for-the-public" target="_blank"> the UK</a></td>
                <td><a href="http://irangov.ir/cat/509" target="_blank"> Iran</a></td>
              </tr>
            </table>
            <br><b>Other Resources:</b>
            <ul>
              <li><a href="https://ncov.dxy.cn/" target="_blank"> Dingxiangyuan</a></li> (Update national daily data and educate Coronavirus knowledge)
              <li><a href="http://zhongxinzhiyuan.cn/yiqing_real_time_map.html" target="_blank"> Zhongxinzhiyuan</a></li> (Update the latest news and data visualization)
              <li><a href="http://2019ncov.nosugartech.com/search.html" target="_blank"> Tongchengchaxun</a></li> (Coronavirus confirmed patients' trips query tool)
              <li><a href="https://voice.baidu.com/act/newpneumonia/newpneumonia" target="_blank"> Baidu Coronavirus Data Report</a></li> (Update Global daily data and hot topics about Coronavirus)
              <li><a href="https://www.nejm.org/coronavirus" target="_blank"> The New England Journal of Medicine</a></li> (A collection of articles and other resources on the Coronavirus (Covid-19) outbreak, including clinical reports, management
              guidelines, and commentary)
              <li><a href="http://www.nhc.gov.cn/xcs/pfzs/list_gzbd.shtml" target="_blank"> National Health Commission of the People's Republic of China </a></li> (Coronavirus(Covid-19) legal knowledge)
            </ul>
            </p>
          </div>
        </div>
      </div>
    </div>
  </div>
  <script>
    $(window).ready(function() {
      $('.loader').fadeOut("slow");
    });



    L.TopoJSON = L.GeoJSON.extend({
      addData: function(jsonData) {
        if (jsonData.type === 'Topology') {
          for (key in jsonData.objects) {
            geojson = topojson.feature(jsonData, jsonData.objects[key]);
            L.GeoJSON.prototype.addData.call(this, geojson);
          }
        } else {
          L.GeoJSON.prototype.addData.call(this, jsonData);
        }
      }
    });
    // Copyright (c) 2013 Ryan Clark

    // var createLabelIcon = function(labelClass, labelText) {
    //   return L.divIcon({
    //     className: labelClass,
    //     html: labelText
    //   })
    // }
    //


    var usBounds = L.latLngBounds(
      L.latLng(-60, -100), //Southwest
      L.latLng(80, 15) //Northeast
    );


    // var mymap = L.map('map', {
    //   center: [38, -120],
    //   zoomControl: false,
    //   zoom: 4,
    //   maxZoom: 10,
    //   minZoom: 2,
    //   worldCopyJump: true
    // });

    var mymap = L.map('map', {
      center: [38, -120],
      zoomControl: false,
      zoom: 4,
      maxZoom: 10,
      minZoom: 2,
      worldCopyJump: true
    }).fitBounds(usBounds);
    // .fitWorld()
    new L.Control.Zoom({
      position: 'topright'
    }).addTo(mymap);





    var gray = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}@2x.png');
    // var dark = L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}@2x.png').addTo(mymap);
    var voyager =
      L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}@2x.png').addTo(mymap);
    var satellite =
      L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}');

    var baseLayers = {
      'CARTO Light': gray,
      // 'Dark': dark,
      'CARTO Voyager': voyager,
      'ESRI Satellite': satellite
    }



    var chart, rchart;

    var colors = chroma.scale('YlOrRd').mode('lch').colors(6);
    for (i = 0; i < 6; i++) {
      $('head').append($("<style> .region-color-" + (i + 1).toString() + " { color: " + colors[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
      $('head').append($("<style> .legend-color-" + (i + 1).toString() + " { background: " + colors[i] + "; font-size: 15px; text-shadow: 0 0 3px #ffffff;} </style>"));
    }


    var communities = new L.MarkerClusterGroup({
      spiderfyOnMaxZoom: false,
      singleMarkerMode: true,
      // showCoverageOnHover: false,
      // zoomToBoundsOnClick: false,
      iconCreateFunction: function(cluster) {
        return L.divIcon({
          // html: '<i class="fas fa-procedures community community-marker"> <b>' + cluster.getChildCount() + '</b></i>'
          html: '<i class="fas fa-procedures community community-marker"> <b>' + cluster.getChildCount() + '</b></i>'
        });
      }

    });

    var cases = new L.MarkerClusterGroup({
      spiderfyOnMaxZoom: true,
      singleMarkerMode: true,
      polygonOptions: {
        fillColor: "red",
        color: 'red',
        weight: 0.5,
        opacity: 0.6,
        fillOpacity: 0.2
      },
      showCoverageOnHover: true,
      // zoomToBoundsOnClick: false,
      iconCreateFunction: function(cluster) {
        cnt = cluster.getChildCount()

        if (cnt >= 70) {
          return L.divIcon({
            // html: '<i class="fas fa-users community community-marker"> <b>' + cluster.getChildCount() + '</b></i>'
            html: '<i class="fas fa-users community community-marker fa-2x "> <b>' + "" + '</b></i>'
          });
        } else if (cnt >= 10 && cnt < 70) {
          return L.divIcon({
            // html: '<i class="fas fa-users community community-marker"> <b>' + cluster.getChildCount() + '</b></i>'
            html: '<i class="fas fa-users community community-marker fa-lg "> <b>' + "" + '</b></i>'
          });

        } else {
          return L.divIcon({
            // html: '<i class="fas fa-users community community-marker"> <b>' + cluster.getChildCount() + '</b></i>'
            html: '<i class="fas fa-users community community-marker fa-sm "> <b>' + "" + '</b></i>'
          });
        }
      }

    }).addTo(mymap);



    Promise.all([
      d3.csv('assets/virus.csv'),
      d3.json("assets/all-topo-15.json"),
      d3.csv('assets/communities.csv'),
      d3.csv('assets/timestamp.txt'),
      d3.csv('assets/cases.csv')
    ]).then(function(datasets) {


      datasets[2].forEach(function(d) {
        L.marker([parseFloat(d.lat), parseFloat(d.lng)]).bindPopup(d.name + "&nbsp;&nbsp;(<a target='_blank' href='https://translate.google.com/#view=home&op=translate&sl=zh-CN&tl=en&text=" + d.name + "'>Translate to English</a>)").addTo(
          communities);
      })


      datasets[4].forEach(function(d) {
        //console.log(d.id)
        L.marker([parseFloat(d.lat), parseFloat(d.lng)]).bindPopup("<b>" + d.no + "</b> <p>" + d.note + " identified on " + d.date + ", &nbsp;" + d.reference + ".</p>").addTo(
          cases);
      })

      // lastupdate = new Date(datasets[0][datasets[0].length - 1]["datetime"]);
      // $("#date").text("Last update: " + lastupdate.toLocaleDateString() + " " + lastupdate.toLocaleTimeString() + " PST");

      $("#date").text("Last update: " + datasets[3][0].timestamp.split(".")[0] + " PST");



      //totalConfirmed
      function tc(country) {
        if (country == undefined) {
          country = 0
        } else {
          country = +country.split("-")[0];
        }
        return country;
      }

      //totalRecovered
      function tr(country) {
        if (country.split("-")[2] == undefined) {
          country = 0
        } else {
          country = +country.split("-")[2];
        }
        return country;
      }

      //totalDeath
      function td(country) {
        if (country.split("-")[3] == undefined) {
          country = 0
        } else {
          country = +country.split("-")[3];
        }
        return country;
      }


      var latest = datasets[0][datasets[0].length - 1];

      var china = tc(latest["anhui"]) + tc(latest["beijing"]) + tc(latest["chongqing"]) + tc(latest["fujian"]) + tc(latest["gansu"]) + tc(latest["guangdong"]) + tc(latest["guangxi"]) + tc(latest["guizhou"]) + tc(latest["hainan"]) + tc(latest[
          "hebei"]) + tc(latest["heilongjiang"]) + tc(latest["henan"]) + tc(latest["hongkong"]) + tc(latest["hubei"]) + tc(latest["hunan"]) + tc(latest["neimenggu"]) + tc(latest["jiangsu"]) + tc(latest["jiangxi"]) + tc(latest["jilin"]) + tc(
          latest["liaoning"]) + tc(latest["macau"]) + tc(latest["ningxia"]) + tc(latest["qinghai"]) + tc(latest["shaanxi"]) + tc(latest["shandong"]) + tc(latest["shanghai"]) + tc(latest["shanxi"]) + tc(latest["sichuan"]) + tc(latest["taiwan"]) +
        tc(latest["tianjin"]) + tc(latest["xinjiang"]) + tc(latest["yunnan"]) + tc(latest["zhejiang"]) + tc(latest["xizang"]);

      var top = {
        "China": china,
        "Japan": tc(latest["japan"]),
        "US": tc(latest["us"]),
        "Singapore": tc(latest["singapore"]),
        "South Korea": tc(latest["south korea"]),
        "Germany": tc(latest["germany"]),
        "Spain": tc(latest["spain"]),
        "Iran": tc(latest["iran"]),
        "Italy": tc(latest["italy"]),
        "France": tc(latest["france"]),
        "Thailand": tc(latest["thailand"])
      };


      function sortJsObject(obj) {
        items = Object.keys(obj).map(function(key) {
          return [key, obj[key]];
        });
        items.sort(function(first, second) {
          return second[1] - first[1];
        });
        sorted_obj = {}
        $.each(items, function(k, v) {
          use_key = v[0]
          use_value = v[1]
          sorted_obj[use_key] = use_value
        })
        return (sorted_obj)
      }


      stop = sortJsObject(top);

      var t = ["t"];
      var confirmed = ["Aggr. Confirmed"];
      var active = ["Active Confirmed"];
      var suspected = ["Suspected"];
      var recovered = ["Recovered"];
      var death = ["Death"]
      var global = {
        name: "Global Trend",
        c: confirmed,
        s: suspected,
        r: recovered,
        d: death,
        a: active
      }

      function calCounts(i) {
        cf = 0, sp = 0, rc = 0, dd = 0, active = 0;
        datasets[0].forEach(function(d) {
          var USTd = new Date(d["datetime"]);
          t.push(USTd.setHours(USTd.getHours() + 8));
          // t.push(new Date(d["datetime"]));
          cf = 0, sp = 0, rc = 0, dd = 0, active = 0;
          current = d;
          delete current["datetime"];


          if (i["name"] == "Global Trend") {

            Object.values(current).forEach(function(d) {
              if (d == undefined) {
                d = "0"
              };
              items = d.split("-");
              switch (items.length) {
                case 4:
                  dd += +items[3];
                case 3:
                  rc += +items[2];
                case 2:
                  sp += +items[1];
                case 1:
                  cf += +items[0];
                  break;
              };
              active = cf - dd - rc;
            });
            //
            cf -= (tc(current["alabama"]) + tc(current["alaska"]) + tc(current["arizona"]) + tc(current["arkansas"]) + tc(current["california"]) + tc(current["colorado"]) + tc(current["connecticut"]) + tc(current["delaware"]) + tc(current[
                "florida"]) + tc(current["georgia usa"]) + tc(current["hawaii"]) + tc(current["idaho"]) + tc(current["illinois"]) + tc(current["indiana"]) + tc(current["iowa"]) + tc(current["kansas"]) + tc(current["kentucky"]) + tc(current[
                "louisiana"]) + tc(current["maine"]) + tc(current["maryland"]) + tc(current["massachusetts"]) + tc(current["michigan"]) + tc(current["minnesota"]) + tc(current["mississippi"]) + tc(current["missouri"]) + tc(current[
                "montana"]) + tc(
                current["nebraska"]) + tc(current["nevada"]) + tc(current["new hampshire"]) + tc(current["new jersey"]) + tc(current["new mexico"]) + tc(current["new york"]) + tc(current["north carolina"]) + tc(current["north dakota"]) +
              tc(current[
                "ohio"]) + tc(current["oklahoma"]) + tc(current["oregon"]) + tc(current["pennsylvania"]) + tc(current["rhode island"]) + tc(current["south carolina"]) + tc(current["south dakota"]) + tc(current["tennessee"]) + tc(current[
                "texas"]) +
              tc(current["utah"]) + tc(current["vermont"]) + tc(current["virginia"]) + tc(current["washington"]) + tc(current["west virginia"]) + tc(current["canada"]));

            rc -= (tr(current["alabama"]) + tr(current["alaska"]) + tr(current["arizona"]) + tr(current["arkansas"]) + tr(current["california"]) + tr(current["colorado"]) + tr(current["connecticut"]) + tr(current["delaware"]) + tr(current[
                "florida"]) + tr(current["georgia usa"]) + tr(current["hawaii"]) + tr(current["idaho"]) + tr(current["illinois"]) + tr(current["indiana"]) + tr(current["iowa"]) + tr(current["kansas"]) + tr(current["kentucky"]) + tr(current[
                "louisiana"]) + tr(current["maine"]) + tr(current["maryland"]) + tr(current["massachusetts"]) + tr(current["michigan"]) + tr(current["minnesota"]) + tr(current["mississippi"]) + tr(current["missouri"]) + tr(current[
                "montana"]) + tc(
                current["nebraska"]) + tr(current["nevada"]) + tr(current["new hampshire"]) + tr(current["new jersey"]) + tr(current["new mexico"]) + tr(current["new york"]) + tr(current["north carolina"]) + tr(current["north dakota"]) +
              tr(current[
                "ohio"]) + tr(current["oklahoma"]) + tr(current["oregon"]) + tr(current["pennsylvania"]) + tr(current["rhode island"]) + tr(current["south carolina"]) + tr(current["south dakota"]) + tr(current["tennessee"]) + tr(current[
                "texas"]) +
              tr(current["utah"]) + tr(current["vermont"]) + tr(current["virginia"]) + tr(current["washington"]) + tr(current["west virginia"]) + tr(current["canada"]));

            dd -= (td(current["alabama"]) + td(current["alaska"]) + td(current["arizona"]) + td(current["arkansas"]) + td(current["california"]) + td(current["colorado"]) + td(current["connecticut"]) + td(current["delaware"]) + td(current[
                "florida"]) + td(current["georgia usa"]) + td(current["hawaii"]) + td(current["idaho"]) + td(current["illinois"]) + td(current["indiana"]) + td(current["iowa"]) + td(current["kansas"]) + td(current["kentucky"]) + td(current[
                "louisiana"]) + td(current["maine"]) + td(current["maryland"]) + td(current["massachusetts"]) + td(current["michigan"]) + td(current["minnesota"]) + td(current["mississippi"]) + td(current["missouri"]) + td(current[
                "montana"]) + tc(
                current["nebraska"]) + td(current["nevada"]) + td(current["new hampshire"]) + td(current["new jersey"]) + td(current["new mexico"]) + td(current["new york"]) + td(current["north carolina"]) + td(current["north dakota"]) +
              td(current[
                "ohio"]) + td(current["oklahoma"]) + td(current["oregon"]) + td(current["pennsylvania"]) + td(current["rhode island"]) + td(current["south carolina"]) + td(current["south dakota"]) + td(current["tennessee"]) + td(current[
                "texas"]) +
              td(current["utah"]) + td(current["vermont"]) + td(current["virginia"]) + td(current["washington"]) + td(current["west virginia"]) + td(current["canada"]));


          } else if (i["name"] == "china") {


            for (const [key, value] of Object.entries(current)) {

              if (key == "anhui" || key == "beijing" || key == "chongqing" || key == "fujian" || key == "gansu" || key == "guangdong" ||
                key == "guangxi" || key == "guizhou" || key == "hainan" || key == "hebei" || key == "heilongjiang" || key == "henan" || key == "hongkong" ||
                key == "hubei" || key == "hunan" || key == "neimenggu" || key == "jiangsu" || key == "jiangxi" || key == "jilin" || key == "liaoning" ||
                key == "macau" || key == "ningxia" || key == "qinghai" || key == "shaanxi" || key == "shandong" || key == "shanghai" || key == "shanxi" ||
                key == "sichuan" || key == "taiwan" || key == "tianjin" || key == "xinjiang" || key == "yunnan" || key == "zhejiang" || key == "xizang") {


                if (value == undefined) {
                  value = "0"
                };
                items = value.split("-");
                switch (items.length) {
                  case 4:
                    dd += +items[3];
                  case 3:
                    rc += +items[2];
                  case 2:
                    sp += +items[1];
                  case 1:
                    cf += +items[0];
                    break;
                };
                active = cf - dd - rc;
              }
            }


          } else {


            d = current[i["name"]];
            if (d == undefined) {
              d = "0"
            };
            items = d.split("-");
            switch (items.length) {
              case 4:
                dd += +items[3];
              case 3:
                rc += +items[2];
              case 2:
                sp += +items[1];
              case 1:
                cf += +items[0];
                break;
            };
            active = cf - dd - rc;



          }

          i["c"].push(cf);
          // i["s"].push(sp);
          i["r"].push(rc);
          i["d"].push(dd);
          i["a"].push(active);
        });
        active = cf - rc - dd;
        $(".confirmed-count").text(cf);
        // $(".suspected-count").text(sp);
        $(".recovered-count").text(rc);
        $(".death-count").text(dd);
        $(".active-count").text(active);

        nc = i.c[i.c.length - 1] - i.c[i.c.length - 2];
        nr = i.r[i.r.length - 1] - i.r[i.r.length - 2];
        nd = i.d[i.d.length - 1] - i.d[i.d.length - 2];
        na = i.a[i.a.length - 1] - i.a[i.a.length - 2];

        if (nc > 0) {
          $(".confirmed-new-count").text("+" + nc.toString());
        } else if (nc == 0) {
          $(".confirmed-new-count").text("");
        } else {

          $(".confirmed-new-count").text(nc.toString());
        }

        if (nr > 0) {
          $(".recovered-new-count").text("+" + nr.toString());
        } else if (nr == 0) {
          $(".recovered-new-count").text("")
        } else {
          $(".recovered-new-count").text(nr.toString());
        }
        if (nd > 0) {
          $(".death-new-count").text("+" + nd.toString());
        } else if (nd == 0) {
          $(".death-new-count").text("")
        } else {
          $(".death-new-count").text(nd.toString());
        }
        if (na > 0) {
          document.getElementById("counticon").style.display = "initial";
          $(".active-new-count").text("+" + na.toString());
        } else if (na < 0) {
          document.getElementById("counticon").style.display = "initial";
          $(".active-new-count").text("" + na.toString());
        } else if (na == 0) {
          document.getElementById("counticon").style.display = "none";
          $(".active-new-count").text("")
        } else {
          document.getElementById("counticon").style.display = "none";
          $(".active-new-count").text(na.toString());
        }


        if (i["name"] == "anhui" || i["name"] == "beijing" || i["name"] == "chongqing" || i["name"] == "fujian" || i["name"] == "gansu" || i["name"] == "guangdong" ||
          i["name"] == "guangxi" || i["name"] == "guizhou" || i["name"] == "hainan" || i["name"] == "hebei" || i["name"] == "heilongjiang" || i["name"] == "henan" || i["name"] == "hongkong" ||
          i["name"] == "hubei" || i["name"] == "hunan" || i["name"] == "neimenggu" || i["name"] == "jiangsu" || i["name"] == "jiangxi" || i["name"] == "jilin" || i["name"] == "liaoning" ||
          i["name"] == "macau" || i["name"] == "ningxia" || i["name"] == "qinghai" || i["name"] == "shaanxi" || i["name"] == "shandong" || i["name"] == "shanghai" || i["name"] == "shanxi" ||
          i["name"] == "sichuan" || i["name"] == "tianjin" || i["name"] == "xinjiang" || i["name"] == "yunnan" || i["name"] == "zhejiang" || i["name"] == "xizang") {
          $("#placename").text(i["name"].toUpperCase() + ", CHINA");
        } else {
          $("#placename").text(i["name"].toUpperCase());
        }

      }

      function setFill(enname) {
        var pop = datasets[0][datasets[0].length - 1][enname];
        if (pop == "" || pop == undefined || pop.toString().split("-")[0] == "0") {
          return 'url(img/texture-s.png)'; //non-case country, 0 aggregate confirm
        } else {
          pop = +pop.toString().split("-")[0] - +pop.toString().split("-")[2] - +pop.toString().split("-")[3]; // remaining confirmed
          // return "#00000000";
        }
        if (pop == 0) {
          return 'url(img/texture-sg.png)'; // 0 active confirm
          // return 'url("data:image/svg+xml;base64,PHN2ZyB4bWxucz0naHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmcnIHdpZHRoPScxMCcgaGVpZ2h0PScxMCc+CiAgPHJlY3Qgd2lkdGg9JzEwJyBoZWlnaHQ9JzEwJyBmaWxsPSd3aGl0ZScgLz4KICA8cmVjdCB4PScwJyB5PScwJyB3aWR0aD0nMScgaGVpZ2h0PScxJyBmaWxsPSdibGFjaycgLz4KPC9zdmc+")';
        } else {
          return 'url()';
        }


      }

      function setColor(enname) {
        var id = 0;
        var pop = datasets[0][datasets[0].length - 1][enname];

        if (pop != undefined) {
          pop = +pop.toString().split("-")[0] - +pop.toString().split("-")[2] - +pop.toString().split("-")[3]; // remaining confirmed
        } else {
          pop = 0;
          // return "#00000000";
        }

        if (pop >= 10000) {
          id = 5;
        } else if (pop > 1000 && pop <= 10000) {
          id = 4;
        } else if (pop > 250 && pop <= 1000) {
          id = 3;
        } else if (pop > 100 && pop <= 250) {
          id = 2;
        } else if (pop > 10 && pop <= 100) {
          id = 1;
        } else if (pop > 0 && pop <= 10) {
          id = 0;
        } else {
          id = -1;
          return "#00000000";
        }

        return colors[id];

      }


      function style(feature) {
        if (feature.properties.enname == "us" || feature.properties.enname == "canada") {
          return {
            fillOpacity: 0,
            opacity: 0,
          };
        } else {
          return {
            fill: setFill(feature.properties.enname),
            fillColor: setColor(feature.properties.enname),
            fillOpacity: 0.4,
            weight: 0.5,
            opacity: 1,
            color: '#b4b4b4',
            dashArray: '2'
          };
        }
      }



      function highlightFeature(e) {
        // e indicates the current event
        var layer = e.target; //the target capture the object which the event associates with
        layer.setStyle({
          weight: 2,
          opacity: 0.8,
          color: '#e3e3e3',
          fillColor: '#00ffd9',
          fillOpacity: 0.1
        });
        // bring the layer to the front.
        layer.bringToFront();
        if (e.target.feature.properties.enname == "us" || e.target.feature.properties.enname == "canada") {
          layer.bringToBack();
        }
      }

      // 3.2.2 zoom to the highlighted feature when the mouse is clicking onto it.
      function zoomToFeature(e) {
        // mymap.fitBounds(e.target.getBounds());
        L.DomEvent.stopPropagation(e);
        $("#hint").text("Click here to the global trend.");
        displayPlace(e.target.feature.properties.enname)
      }

      // 3.2.3 reset the hightlighted feature when the mouse is out of its region.
      function resetHighlight(e) {
        areas.resetStyle(e.target);

      }

      // 3.3 add these event the layer obejct.
      function onEachFeature(feature, layer) {
        layer.on({
          mouseover: highlightFeature,
          click: zoomToFeature,
          mouseout: resetHighlight
        });
      }

      var areas = new L.TopoJSON(datasets[1], {
        style: style,
        onEachFeature: onEachFeature
      }).addTo(mymap);


      new L.control.layers(baseLayers, {
        "Infection Level": areas,
        "Infection Case(s) &nbsp;&nbsp; <i class='fas fa-users community'></i>": cases,
        "Infected Community &nbsp;&nbsp; <i class='fas fa-procedures community'></i>": communities
      }, {
        collapsed: false
      }).addTo(mymap);



      $("#hint").on("click", function() {
        calCounts(global);
        chart.load({
          columns: [global.c, global.a, global.r, global.d],
          unload: ['Aggr. Confirmed', 'Active Confirmed', 'Recovered', 'Death'],
        });

        $("#hint").text("Click a place to review local trend.");

      });


      function onMapClick(e) {
        $("#hint").click();
      }

      mymap.on('click', onMapClick);

      calCounts(global);


      chart = c3.generate({
        size: {
          height: 280,
          width: 460
        },
        data: {
          x: "t",
          y: "confirmed",
          columns: [t, global.c, global.a, global.r, global.d],
          type: 'line',
          axes: {
            confirmed: 'y'
          },
          colors: {
            'Aggr. Confirmed': '#dc3545',
            // Suspected: 'orange',
            'Active Confirmed': 'orange',
            Recovered: '#28a745',
            Death: '#5d4f72e8'
          }
        },
        zoom: {
          enabled: true
        },
        axis: {
          x: {
            type: "timeseries",
            tick: {
              format: "%b %d",
              centered: true,
              fit: true,
              count: 8
            }
          },
          y: {
            label: {
              text: 'Cases',
              position: 'outer-middle'
            },
            min: 0,
            padding: {
              bottom: 0
            },
            type: 'linear'
          }
        },
        point: {
          r: 3,
          focus: {
            expand: {
              r: 5
            }
          }
        },
        zoom: {
          // rescale: true,
          enabled: false,
          type: "scroll",
        },
        tooltip: {
          linked: true,
        },
        legend: {
          position: 'inset',
          inset: {
            anchor: "top-left",
            y: 10
          },
        },
        bindto: "#total-chart"
      });


      x = Object.keys(stop).slice(0, 9);
      x.reverse();
      x.push("x");
      x.reverse();

      y = Object.values(stop).slice(0, 9);
      y.reverse();
      y.push("Confirmed Cases");
      y.reverse();

      function displayPlace(placeName) {

        var confirmed = ["Aggr. Confirmed"];
        var suspected = ["Suspected"];
        var recovered = ["Recovered"];
        var active = ["Active Confirmed"];
        var death = ["Death"]
        var place = {
          name: placeName,
          c: confirmed,
          s: suspected,
          r: recovered,
          d: death,
          a: active
        }

        calCounts(place);

        chart.load({
          columns: [place.c, place.a, place.r, place.d],
          unload: ['Aggr. Confirmed', 'Active Confirmed', 'Recovered', 'Death'],
        });


      }



      function buildPlace(placeName) {

        var confirmed = ["Aggr. Confirmed"];
        var suspected = ["Suspected"];
        var recovered = ["Recovered"];
        var active = ["Active Confirmed"];
        var death = ["Death"]
        var place = {
          name: placeName,
          c: confirmed,
          s: suspected,
          r: recovered,
          d: death,
          a: active
        }

        calCounts(place);

        chart.load({
          columns: [place.c, place.a, place.r, place.d],
          unload: ['Aggr. Confirmed', 'Active Confirmed', 'Recovered', 'Death'],
        });


      }

      rchart = c3.generate({
        size: {
          height: 200,
          width: 460
        },
        data: {
          x: 'x',
          columns: [
            x, y
          ],
          type: 'bar',
          onmouseover: function(d) {
            displayPlace(x[d.x + 1].toLowerCase());
          },
        },
        axis: {
          x: {
            type: 'category',

            tick: {
              rotate: -60,
              multiline: false
            }
          },
          y: {
            label: {
              text: 'Confirmed Cases',
              position: 'outer-middle'
            },
            tick: {
              values: [1000, 5000, 10000, 30000, 100000, 200000]
            },
            // min: -1000,
            max: 30000,
            padding: 1500,
            type: 'log'
          }
        },
        legend: {
          show: false
        },
        bindto: "#rank-chart"
      });





      // $('#panelSwitcher').change(function() {
      //
      //   if (document.getElementById('panelSwitcher').checked) {
      //       $("#table").css("visibility", "hidden");
      //       $(".leaflet-control-container").css("visibility", "visible");
      //
      //   } else {
      //
      //     $("#table").css("visibility", "visible");
      //     $(".leaflet-control-container").css("visibility", "hidden");
      //
      //   }
      //
      //
      // })









    });

    /////////////////////////

    function dailyUpdate(d) {
      // var currentDate = new Date(d.x.toString());
      // console.log(month);
      $("#date").text(d.x.toString().split(" 2020")[0].substring(4));

    }


    $(".leaflet-control-attribution")
      .css("background-color", "transparent")
      .html("");
  </script>

  <!-- Google Analytics -->
  <script>
    window.ga = window.ga || function() {
      (ga.q = ga.q || []).push(arguments)
    };
    ga.l = +new Date;
    ga('create', 'UA-100818948-4', 'auto');
    ga('send', 'pageview');
  </script>
  <script async src='https://www.google-analytics.com/analytics.js'></script>
  <!-- End Google Analytics -->
  <!-- Global site tag (gtag.js) - Google Analytics -->
  <script async src="https://www.googletagmanager.com/gtag/js?id=UA-159947082-1"></script>
  <script>
    window.dataLayer = window.dataLayer || [];

    function gtag() {
      dataLayer.push(arguments);
    }
    gtag('js', new Date());

    gtag('config', 'UA-159947082-1');
  </script>
</body>

</html>
